name: Check license

on:
  - pull_request

jobs:
  check:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/javascript-action@v1
      - uses: actions/checkout@v2

      - name: Check source code
        run: |
          # Compare header license in misc/HEADER with the first lines of each source code file
          find  '(' -type f ! -path './misc*' ')'                                                 \
                '('                                                                               \
                        -name '*.cpp'                                                             \
                    -o  -name '*.h'                                                               \
                    -o  -name '*.hpp'                                                             \
                    -o  -name '*.tpp'                                                             \
                    -o  -name '*.ipp'                                                             \
                    -o  -name '*.cu'                                                              \
                ')'                                                                               \
            | xargs -I{} sh -c                                                                    \
                "head -n9 {} | diff -sq - misc/HEADER > /dev/null || echo {}"                     \
            > source_code.check
          for filepath in `cat source_code.check`; do                                         \
            echo "::error file=$filepath,line=1,title=$filepath::check the license";             \
          done
          test ! -s source_code.check

      - name: Check failed
        if: failure()
        run: cat source_code.check
