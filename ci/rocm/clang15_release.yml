#
# Distributed Linear Algebra with Future (DLAF)
#
# Copyright (c) ETH Zurich
# All rights reserved.
#
# Please, refer to the LICENSE file in the root directory.
# SPDX-License-Identifier: BSD-3-Clause
#
include:
  - local: 'ci/common-ci.yml'

rocm clang15 release deps:
  extends: .build_deps_common-mi
  variables:
    BASE_IMAGE: $CSCS_REGISTRY_PATH/base-images/rocm-6.0.2-dev-ubuntu-22.04:v0.1
    EXTRA_APTGET: "clang-15 libomp-15-dev rocblas rocblas-dev rocsolver rocsolver-dev llvm-amdgpu rocm-device-libs"
    COMPILER: clang@15
    USE_ROCBLAS: "ON"
    SPACK_ENVIRONMENT: ci/docker/release-rocm602.yaml
    DEPS_IMAGE: $CSCS_REGISTRY_PATH/rocm-clang15-release/deps

rocm clang15 release build:
  extends:
    - .build_common
    - .build_for_beverin_mi200
  needs:
    - rocm clang15 release deps
  variables:
    DLAF_IMAGE: $CSCS_REGISTRY_PATH/rocm-clang15-release/dlaf:$CI_COMMIT_SHA

rocm clang15 release test:
  extends: .run_common
  variables:
    DLAF_CI_BIND_GPU: "MI250X"
    PIKA_MPI_ENABLE_POOL: 1
    PIKA_MPI_COMPLETION_MODE: 30
    MPICH_GPU_SUPPORT_ENABLED: 0
  needs:
    - rocm clang15 release build
  trigger:
    include:
      - artifact: pipeline.yml
        job: rocm clang15 release build
